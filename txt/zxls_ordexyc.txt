zxls_ordexyc:--zxls_ordexyc
SET QUOTED_IDENTIFIER OFF
IF OBJECT_ID('tempdb..#bbm')is not null
BEGIN
   drop table #bbm
END

IF OBJECT_ID('tempdb..#bbs')is not null
BEGIN
   drop table #bbs
END

declare @t_odate nvarchar(30)=dbo.AD2ChineseEraName((select b from ztmpxls where charindex('',b)>0))

declare @a nvarchar(MAX),@b nvarchar(MAX),@c nvarchar(MAX)
,@d nvarchar(MAX),@e nvarchar(MAX),@f nvarchar(MAX),@g nvarchar(MAX),@h nvarchar(MAX),@i nvarchar(MAX)
,@j nvarchar(MAX),@k nvarchar(MAX),@l nvarchar(MAX),@m nvarchar(MAX),@n nvarchar(MAX),@o nvarchar(MAX)
,@p nvarchar(MAX),@q nvarchar(MAX),@r nvarchar(MAX),@s nvarchar(MAX),@t nvarchar(MAX),@u nvarchar(MAX)
,@v nvarchar(MAX),@w nvarchar(MAX),@x nvarchar(MAX),@y nvarchar(MAX),@z nvarchar(MAX),@ai nvarchar(MAX)
,@aj nvarchar(MAX),@ak nvarchar(MAX),@al nvarchar(MAX),@am nvarchar(MAX),@an nvarchar(MAX)
,@ap nvarchar(MAX),@aq nvarchar(MAX),@ar nvarchar(MAX),@as nvarchar(MAX),@at nvarchar(MAX)

,@td nvarchar(MAX),@te nvarchar(MAX),@tf nvarchar(MAX),@tg nvarchar(MAX),@th nvarchar(MAX),@ti nvarchar(MAX)
,@tj nvarchar(MAX),@tk nvarchar(MAX),@tl nvarchar(MAX),@tm nvarchar(MAX),@tn nvarchar(MAX),@to nvarchar(MAX)
,@tp nvarchar(MAX),@tq nvarchar(MAX),@tr nvarchar(MAX),@ts nvarchar(MAX),@tt nvarchar(MAX),@tu nvarchar(MAX)
,@tv nvarchar(MAX),@tw nvarchar(MAX),@tx nvarchar(MAX),@ty nvarchar(MAX),@tz nvarchar(MAX),@tai nvarchar(MAX)
,@taj nvarchar(MAX),@tak nvarchar(MAX),@tal nvarchar(MAX),@tam nvarchar(MAX),@tan nvarchar(MAX)
,@tap nvarchar(MAX),@taq nvarchar(MAX),@tar nvarchar(MAX),@tas nvarchar(MAX),@tat nvarchar(MAX)

declare @custno1 nvarchar(MAX),@custno2 nvarchar(MAX),@custno3 nvarchar(MAX),@custno4 nvarchar(MAX),@custno5 nvarchar(MAX)
,@custno6 nvarchar(MAX),@custno7 nvarchar(MAX),@custno8 nvarchar(MAX),@custno9 nvarchar(MAX),@custno10 nvarchar(MAX)
,@custno11 nvarchar(MAX),@custno12 nvarchar(MAX),@custno13 nvarchar(MAX),@custno14 nvarchar(MAX),@custno15 nvarchar(MAX)
,@custno16 nvarchar(MAX),@custno17 nvarchar(MAX),@custno18 nvarchar(MAX),@custno19 nvarchar(MAX),@custno20 nvarchar(MAX)
,@custno21 nvarchar(MAX),@custno22 nvarchar(MAX),@custno23 nvarchar(MAX),@custno24 nvarchar(MAX),@custno25 nvarchar(MAX)
,@custno26 nvarchar(MAX),@custno27 nvarchar(MAX),@custno28 nvarchar(MAX),@custno29 nvarchar(MAX),@custno30 nvarchar(MAX)
,@custno31 nvarchar(MAX),@custno32 nvarchar(MAX),@custno33 nvarchar(MAX),@custno34 nvarchar(MAX)


declare @tmp table(
		custno nvarchar(100),
		comp nvarchar(100),
		productno nvarchar(100),
		product nvarchar(100),
		unit nvarchar(100),
		price float,
		mount float,
		total float
	)

	declare cursor_table cursor for 
	select a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t
			,u,v,w,x,y,z,ai,aj,ak,al,am,an,ap,ar,[as],at 
	from ztmpxls 
	where a!='' and cast(noa as int)>5
	order by noa
	open cursor_table 
	fetch next from cursor_table 
	into @a,@b,@c,@d,@e,@f,@g,@h,@i,@j,@k,@l,@m,@n,@o,@p,@q,@r,@s,@t
			,@u,@v,@w,@x,@y,@z,@ai,@aj,@ak,@al,@am,@an,@ap,@ar,@as,@at
	while(@@FETCH_STATUS <> -1) 
	begin	
	--設定客戶
		if(@a='料號')
		begin
			set @td=@d
			set @te=@e
			set @tf=@f
			set @tg=@g
			set @th=@h
			set @ti=@i
			set @tj=@j
			set @tk=@k
			set @tl=@l
			set @tm=@m
			set @tn=@n
			set @to=@o
			set @tp=@p
			set @tq=@q
			set @tr=@r
			set @ts=@s
			set @tt=@t
			set @tu=@u
			set @tv=@v
			set @tw=@w
			set @tx=@x
			set @ty=@y
			set @tz=@z
			set @tai=@ai
			set @taj=@aj
			set @tak=@ak
			set @tal=@al
			set @tam=@am
			set @tan=@an
			set @tap=@ap
			set @taq=@aq
			set @tar=@ar
			set @tas=@as
			set @tat=@at
			set @custno1=isnull((select top 1 noa from cust where boss=@d),'')
			set @custno2=isnull((select top 1 noa from cust where boss=@e),'')
			set @custno3=isnull((select top 1 noa from cust where boss=@f),'')
			set @custno4=isnull((select top 1 noa from cust where boss=@g),'')
			set @custno5=isnull((select top 1 noa from cust where boss=@h),'')
			set @custno6=isnull((select top 1 noa from cust where boss=@i),'')
			set @custno7=isnull((select top 1 noa from cust where boss=@j),'')
			set @custno8=isnull((select top 1 noa from cust where boss=@k),'')
			set @custno9=isnull((select top 1 noa from cust where boss=@l),'')
			set @custno10=isnull((select top 1 noa from cust where boss=@m),'')
			set @custno11=isnull((select top 1 noa from cust where boss=@n),'')
			set @custno12=isnull((select top 1 noa from cust where boss=@o),'')
			set @custno13=isnull((select top 1 noa from cust where boss=@p),'')
			set @custno14=isnull((select top 1 noa from cust where boss=@q),'')
			set @custno15=isnull((select top 1 noa from cust where boss=@r),'')
			set @custno16=isnull((select top 1 noa from cust where boss=@s),'')
			set @custno17=isnull((select top 1 noa from cust where boss=@t),'')
			set @custno18=isnull((select top 1 noa from cust where boss=@u),'')
			set @custno19=isnull((select top 1 noa from cust where boss=@v),'')
			set @custno20=isnull((select top 1 noa from cust where boss=@w),'')
			set @custno21=isnull((select top 1 noa from cust where boss=@x),'')
			set @custno22=isnull((select top 1 noa from cust where boss=@y),'')
			set @custno23=isnull((select top 1 noa from cust where boss=@z),'')
			set @custno24=isnull((select top 1 noa from cust where boss=@ai),'')
			set @custno25=isnull((select top 1 noa from cust where boss=@aj),'')
			set @custno26=isnull((select top 1 noa from cust where boss=@ak),'')
			set @custno27=isnull((select top 1 noa from cust where boss=@al),'')
			set @custno28=isnull((select top 1 noa from cust where boss=@am),'')
			set @custno29=isnull((select top 1 noa from cust where boss=@an),'')
			set @custno30=isnull((select top 1 noa from cust where boss=@ap),'')
			set @custno31=isnull((select top 1 noa from cust where boss=@aq),'')
			set @custno32=isnull((select top 1 noa from cust where boss=@ar),'')
			set @custno33=isnull((select top 1 noa from cust where boss=@as),'')
			set @custno34=isnull((select top 1 noa from cust where boss=@at),'')
			end
		else
		begin
			if(@custno1!='' and @d!='0' and @d!='')
			begin
				insert @tmp (custno,comp,productno,product,unit,mount)
				select @custno1,@td,@a,@b,@c,cast(@d as float)
			end
			if(@custno2!='' and @e!='0' and @e!='')
			begin
				insert @tmp (custno,comp,productno,product,unit,mount)
				select @custno1,@te,@a,@b,@c,cast(@e as float)
			end
			if(@custno3!='' and @f!='0' and @f!='')
			begin
				insert @tmp (custno,comp,productno,product,unit,mount)
				select @custno1,@tf,@a,@b,@c,cast(@f as float)
			end
			if(@custno4!='' and @g!='0' and @g!='')
			begin
				insert @tmp (custno,comp,productno,product,unit,mount)
				select @custno1,@tg,@a,@b,@c,cast(@g as float)
			end
			if(@custno5!='' and @h!='0' and @h!='')
			begin
				insert @tmp (custno,comp,productno,product,unit,mount)
				select @custno1,@th,@a,@b,@c,cast(@h as float)
			end
			if(@custno6!='' and @i!='0' and @i!='')
			begin
				insert @tmp (custno,comp,productno,product,unit,mount)
				select @custno1,@ti,@a,@b,@c,cast(@i as float)
			end
			if(@custno7!='' and @j!='0' and @j!='')
			begin
				insert @tmp (custno,comp,productno,product,unit,mount)
				select @custno1,@tj,@a,@b,@c,cast(@j as float)
			end
			if(@custno8!='' and @k!='0' and @k!='')
			begin
				insert @tmp (custno,comp,productno,product,unit,mount)
				select @custno1,@tk,@a,@b,@c,cast(@k as float)
			end
			if(@custno9!='' and @l!='0' and @l!='')
			begin
				insert @tmp (custno,comp,productno,product,unit,mount)
				select @custno1,@tl,@a,@b,@c,cast(@l as float)
			end
			if(@custno10!='' and @m!='0' and @m!='')
			begin
				insert @tmp (custno,comp,productno,product,unit,mount)
				select @custno1,@tm,@a,@b,@c,cast(@m as float)
			end
			if(@custno11!='' and @n!='0' and @n!='')
			begin
				insert @tmp (custno,comp,productno,product,unit,mount)
				select @custno1,@tn,@a,@b,@c,cast(@n as float)
			end
			if(@custno12!='' and @o!='0' and @o!='')
			begin
				insert @tmp (custno,comp,productno,product,unit,mount)
				select @custno1,@to,@a,@b,@c,cast(@o as float)
			end
			if(@custno13!='' and @p!='0' and @p!='')
			begin
				insert @tmp (custno,comp,productno,product,unit,mount)
				select @custno1,@tp,@a,@b,@c,cast(@p as float)
			end
			if(@custno14!='' and @q!='0' and @q!='')
			begin
				insert @tmp (custno,comp,productno,product,unit,mount)
				select @custno1,@tq,@a,@b,@c,cast(@q as float)
			end
			if(@custno15!='' and @r!='0' and @r!='')
			begin
				insert @tmp (custno,comp,productno,product,unit,mount)
				select @custno1,@tr,@a,@b,@c,cast(@r as float)
			end
			if(@custno16!='' and @s!='0' and @s!='')
			begin
				insert @tmp (custno,comp,productno,product,unit,mount)
				select @custno1,@ts,@a,@b,@c,cast(@s as float)
			end
			if(@custno17!='' and @t!='0' and @t!='')
			begin
				insert @tmp (custno,comp,productno,product,unit,mount)
				select @custno1,@tt,@a,@b,@c,cast(@t as float)
			end
			if(@custno18!='' and @u!='0' and @u!='')
			begin
				insert @tmp (custno,comp,productno,product,unit,mount)
				select @custno1,@tu,@a,@b,@c,cast(@u as float)
			end
			if(@custno19!='' and @v!='0' and @v!='')
			begin
				insert @tmp (custno,comp,productno,product,unit,mount)
				select @custno1,@tv,@a,@b,@c,cast(@v as float)
			end
			if(@custno20!='' and @w!='0' and @w!='')
			begin
				insert @tmp (custno,comp,productno,product,unit,mount)
				select @custno1,@tw,@a,@b,@c,cast(@w as float)
			end
			if(@custno21!='' and @x!='0' and @x!='')
			begin
				insert @tmp (custno,comp,productno,product,unit,mount)
				select @custno1,@tx,@a,@b,@c,cast(@x as float)
			end
			if(@custno22!='' and @y!='0' and @y!='')
			begin
				insert @tmp (custno,comp,productno,product,unit,mount)
				select @custno1,@ty,@a,@b,@c,cast(@y as float)
			end
			if(@custno23!='' and @z!='0' and @z!='')
			begin
				insert @tmp (custno,comp,productno,product,unit,mount)
				select @custno1,@tz,@a,@b,@c,cast(@z as float)
			end
			if(@custno24!='' and @ai!='0' and @ai!='')
			begin
				insert @tmp (custno,comp,productno,product,unit,mount)
				select @custno1,@tai,@a,@b,@c,cast(@ai as float)
			end
			if(@custno25!='' and @aj!='0' and @aj!='')
			begin
				insert @tmp (custno,comp,productno,product,unit,mount)
				select @custno1,@taj,@a,@b,@c,cast(@aj as float)
			end
			if(@custno26!='' and @ak!='0' and @ak!='')
			begin
				insert @tmp (custno,comp,productno,product,unit,mount)
				select @custno1,@tak,@a,@b,@c,cast(@ak as float)
			end
			if(@custno27!='' and @al!='0' and @al!='')
			begin
				insert @tmp (custno,comp,productno,product,unit,mount)
				select @custno1,@tal,@a,@b,@c,cast(@al as float)
			end
			if(@custno28!='' and @am!='0' and @am!='')
			begin
				insert @tmp (custno,comp,productno,product,unit,mount)
				select @custno1,@tam,@a,@b,@c,cast(@am as float)
			end
			if(@custno29!='' and @an!='0' and @an!='')
			begin
				insert @tmp (custno,comp,productno,product,unit,mount)
				select @custno1,@tan,@a,@b,@c,cast(@an as float)
			end
			if(@custno30!='' and @ap!='0' and @ap!='')
			begin
				insert @tmp (custno,comp,productno,product,unit,mount)
				select @custno1,@tap,@a,@b,@c,cast(@ap as float)
			end
			if(@custno31!='' and @aq!='0' and @aq!='')
			begin
				insert @tmp (custno,comp,productno,product,unit,mount)
				select @custno1,@taq,@a,@b,@c,cast(@aq as float)
			end
			if(@custno32!='' and @ar!='0' and @ar!='')
			begin
				insert @tmp (custno,comp,productno,product,unit,mount)
				select @custno1,@tar,@a,@b,@c,cast(@ar as float)
			end
			if(@custno33!='' and @as!='0' and @as!='')
			begin
				insert @tmp (custno,comp,productno,product,unit,mount)
				select @custno1,@tas,@a,@b,@c,cast(@as as float)
			end
			if(@custno34!='' and @at!='0' and @at!='')
			begin
				insert @tmp (custno,comp,productno,product,unit,mount)
				select @custno1,@tat,@a,@b,@c,cast(@at as float)
			end
		end
		fetch next from cursor_table 
		into @a,@b,@c,@d,@e,@f,@g,@h,@i,@j,@k,@l,@m,@n,@o,@p,@q,@r,@s,@t
			,@u,@v,@w,@x,@y,@z,@ai,@aj,@ak,@al,@am,@an,@ap,@ar,@as,@at
	end 
	close cursor_table 
	deallocate cursor_table
	
	create table #bbs(
		noa nvarchar(100),
		no2 nvarchar(10),
		productno nvarchar(100),
		product nvarchar(100),
		spec nvarchar(100),
		classa nvarchar(100),--便/印
		size nvarchar(100),--包裝方式
		dime float, --色數
		source nvarchar(10),--寄/出庫 0
		unit nvarchar(100),
		price float,
		mount float,
		total float,
		custno nvarchar(50),
		comp nvarchar(50),
		memo nvarchar(100),
		enda bit,
		cancel bit,
		quatno nvarchar(50),
		no3 nvarchar(10),
		c1 float,
		notv float
	)

	insert #bbs(custno,comp,productno,product,spec,classa,size,dime,source,unit,price,mount,total,memo,enda,cancel,c1,notv,quatno,no3)
	select a.custno,left(b.comp,50)
	,c.productno,d.product,d.spec,d.style,'',0,'0',a.unit,a.price,a.mount,a.total,'',0,0,0,a.mount
	,isnull(e.noa,''),isnull(e.no3,'')
	from @tmp a left join cust b on a.custno=b.noa
	outer apply (select top 1 * from ucccust where productno=a.productno and (custno='XY001' or custno=left(a.custno,len(custno))))c
	left join ucc d on c.noa=d.noa
	outer apply (select top 1 * from view_quats where productno=c.noa and (custno='XY001' or custno=left(a.custno,len(custno))))e
	
	create table #bbm(
		noa nvarchar(50),
		odate nvarchar(10),
		datea nvarchar(10),
		stype nvarchar(10),
		cno nvarchar(10),
		acomp nvarchar(100),
		custno nvarchar(100),
		comp nvarchar(100),
		nick nvarchar(100),
		paytype nvarchar(100),
		tel nvarchar(100),
		fax nvarchar(100),
		post nvarchar(100),
		addr nvarchar(MAX),
		post2 nvarchar(100),
		addr2 nvarchar(MAX),
		ordbno nvarchar(50),
		ordcno nvarchar(50),
		trantype nvarchar(50),
		salesno nvarchar(50),
		sales nvarchar(50),
		custorde nvarchar(100),
		money float,
		tax float,
		taxtype nvarchar(50),
		total float,
		coin nvarchar(50),
		floata float,
		totalus float,
		vccno nvarchar(50),
		worker nvarchar(50),
		worker2 nvarchar(50),
		weight float,
		apv nvarchar(50),
		memo nvarchar(50),
		isproj bit,
		enda bit,
		cancel bit
	)

	declare @onoq int =cast(isnull(right((select top 1 noa from view_orde where noa like 'E'+REPLACE(@t_odate,'/','')+'%' order by noa desc),3),'000') as int)
	
	if(@onoq<cast(isnull(right((select top 1 noa from dno where tablea='orde' and noa like 'E'+REPLACE(@t_odate,'/','')+'%' order by noa desc),3),'000') as int))
		set @onoq=cast(isnull(right((select top 1 noa from dno where tablea='orde' and noa like 'E'+REPLACE(@t_odate,'/','')+'%' order by noa desc),3),'000') as int)

	insert #bbm(noa,odate,stype,cno,acomp,custno,comp,nick,paytype,tel,fax,post,addr,post2,addr2
	,ordbno,ordcno,trantype,salesno,sales,money,tax,taxtype,total,coin,floata,totalus,vccno,worker,worker2
	,weight,apv,memo,isproj,enda,cancel)
	select 'E'+REPLACE(@t_odate,'/','')+right('000'+cast(ROW_NUMBER()over (order by a.custno)+@onoq as nvarchar(10)),3)
	,@t_odate,'1',b.noa,b.acomp,a.custno,c.comp,c.nick,c.paytype,c.tel,c.fax
	,c.zip_comp,c.addr_comp,c.zip_home,c.addr_home,'','',c.trantype,c.salesno,c.sales
	,0,0,case when d.taxtype='應稅' then '1' when d.taxtype='作廢' then '6' when d.taxtype='零稅率' then '2'
	when d.taxtype='內含' then '3' when d.taxtype='免稅' then '4' when d.taxtype='自訂' then '5' else '' end,0
	,'',0,0,'','瓦城泰統採購單','',0,'','',1,0,0
	from (select custno from #bbs group by custno) a
	outer apply (select top 1 * from acomp order by noa)b
	left join cust c on a.custno=c.noa
	left join custm d on a.custno=d.noa

	update a set noa=b.noa from #bbs a left join #bbm b on a.custno=b.custno

	update a set no2=right('000'+cast(xno2 as nvarchar(10)),3)
	from (select ROW_NUMBER() over (partition by noa order by productno) xno2,no2 from #bbs )a 

	update a
	set money=case when taxtype in ('1','2','4','5') then b.stotal when taxtype='3' then b.stotal-round(b.stotal/1.05*0.05,0)else 0 end
	,tax=case when taxtype='1' then round(b.stotal*0.05,0) when taxtype='3' then round(b.stotal/1.05*0.05,0) else 0 end
	,total=case when taxtype='1' then b.stotal+round(b.stotal*0.05,0) when taxtype in ('2','3','4','5') then b.stotal else 0 end
	from #bbm a outer apply (select SUM(total)stotal from #bbs where noa=a.noa)b

	update #bbm
	set post2='235',addr2='中和市連城路222巷2弄2號1樓'
	where money<=700
	


IF OBJECT_ID('tempdb..#bbm')is not null
BEGIN
   drop table #bbm
END

IF OBJECT_ID('tempdb..#bbs')is not null
BEGIN
   drop table #bbs
END
;